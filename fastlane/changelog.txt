Some minor bugs and performance improvements
